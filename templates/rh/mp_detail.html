{% extends 'base.html' %}
{% load static %}

{% block title %}{{ titulo_pagina|default:"Detalhes da Movimentação" }}{% endblock title %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/rh/mp_detail.css' %}">
{% endblock extra_css %}

{% block content %}
<div class="mp-detail-container">

    <div class="page-header">
        <h1>{{ titulo_pagina|default:"Detalhes da Movimentação Pessoal" }}</h1>
        <span class="status-badge status-{{ mp.status }}">{{ mp.get_status_display }}</span>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <div class="card detail-card">
        
        <div class="detail-section">
            <h3>Informações Gerais</h3>
            <div class="detail-item"><strong>ID da Movimentação:</strong> <span>#{{ mp.id }}</span></div>
            <div class="detail-item"><strong>Solicitante:</strong> <span>{{ mp.solicitante.nome }}</span></div>
            <div class="detail-item"><strong>Data Solicitação:</strong> <span>{{ mp.criado_em|date:"d/m/Y H:i" }}</span></div>
            <div class="detail-item"><strong>Funcionário Movido:</strong> <span>{{ mp.funcionario_movido.nome }}</span></div>
        </div>

        <div class="detail-section">
            <h3>Situação Atual</h3>
            <div class="detail-item"><strong>Cargo Atual:</strong> <span>{{ mp.cargo_atual.nome|default:"N/A" }}</span></div>
            <div class="detail-item"><strong>Setor Atual:</strong> <span>{{ mp.setor_atual.nome|default:"N/A" }}</span></div>
            <div class="detail-item"><strong>Salário Atual:</strong> <span>R$ {{ mp.salario_atual|default:"N/A" }}</span></div>
            {# Adicionar Centro Custo Atual se aplicável #}
        </div>
        
        <div class="detail-section">
            <h3>Situação Proposta</h3>
            <div class="detail-item"><strong>Cargo Proposto:</strong> <span>{{ mp.cargo_proposto.nome }}</span></div>
            <div class="detail-item"><strong>Setor Proposto:</strong> <span>{{ mp.setor_proposto.nome }}</span></div>
            <div class="detail-item"><strong>Salário Proposto:</strong> <span>R$ {{ mp.salario_proposto|default:"N/A" }}</span></div>
            {# Adicionar Centro Custo Proposto se aplicável #}
            <div class="detail-item"><strong>Tipo de Movimentação:</strong> <span>{{ mp.get_tipo_movimentacao_display }}</span></div>
            <div class="detail-item"><strong>Data Efetiva:</strong> <span>{{ mp.data_efetiva|date:"d/m/Y" }}</span></div>
            <div class="detail-item"><strong>Justificativa:</strong> <span class="pre-line">{{ mp.justificativa|default:"Nenhuma" }}</span></div>
            {# Mostrar link do Anexo se houver #}
            {# {% if mp.anexo %} #}
            {# <div class="detail-item"><strong>Anexo:</strong> <span><a href="{{ mp.anexo.url }}" target="_blank">Visualizar Anexo</a></span></div> #}
            {# {% endif %} #}
        </div>

        <div class="detail-section">
            <h3>Histórico de Aprovação</h3>
            <div class="detail-item"><strong>Status Atual:</strong> <span>{{ mp.get_status_display }}</span></div>

            {% if mp.status == 'rejeitada' %}
                <div class="detail-item"><strong>Rejeitado Por:</strong> <span>{{ mp.rejeitado_por.nome|default:"-" }} em {{ mp.data_rejeicao|date:"d/m/Y H:i"|default:"-" }}</span></div>
                <div class="detail-item"><strong>Observação:</strong> <span class="pre-line" style="color: #dc3545;">{{ mp.observacao_rejeicao|default:"-" }}</span></div>
            {% elif mp.aprovador_atual %}
                <div class="detail-item"><strong>Aguardando Aprovação de:</strong> <span>{{ mp.aprovador_atual.nome }}</span></div>
            {% endif %}

            {% if mp.aprovado_por_gestor_proposto %}
            <div class="detail-item"><strong>Aprovado por Gestor Proposto:</strong> <span>{{ mp.aprovado_por_gestor_proposto.nome }} em {{ mp.data_aprovacao_gestor_proposto|date:"d/m/Y H:i" }}</span></div>
            {% endif %}
            {% if mp.aprovado_por_gestor_atual %}
            <div class="detail-item"><strong>Aprovado por Gestor Atual:</strong> <span>{{ mp.aprovado_por_gestor_atual.nome }} em {{ mp.data_aprovacao_gestor_atual|date:"d/m/Y H:i" }}</span></div>
            {% endif %}
            {% if mp.aprovado_por_rh %}
            <div class="detail-item"><strong>Aprovado por RH:</strong> <span>{{ mp.aprovado_por_rh.nome }} em {{ mp.data_aprovacao_rh|date:"d/m/Y H:i" }}</span></div>
            {% endif %}
        </div>

        {# Seção de Ações (Apenas para o Aprovador Atual) #}
        {% if pode_aprovar_rejeitar %}
        <div class="approval-section">
            <h3>Sua Ação</h3>
            <p>Por favor, analise a solicitação e tome uma ação.</p>

            {# Formulário de Rejeição #}
            <form method="post" action="{% url 'rejeitar_mp' mp.pk %}post/" id="form-rejeitar"> {# Adicionado /post/ #}
                {% csrf_token %}
                <div class="form-group">
                    <label for="observacao_rejeicao">Observação (Obrigatória para Rejeitar):</label>
                    <textarea name="observacao" id="observacao_rejeicao" rows="3" placeholder="Informe o motivo da rejeição..."></textarea>
                </div>
            </form>

            {# Formulário de Aprovação (simples) #}
            <form method="post" action="{% url 'aprovar_mp' mp.pk %}post/" id="form-aprovar"> {# Adicionado /post/ #}
                {% csrf_token %}
            </form>

            {# Botões que acionam os formulários #}
            <div class="approval-actions">
                <button type="submit" form="form-aprovar" class="btn btn-approve">
                    <i class="fas fa-check"></i> Aprovar e Encaminhar
                </button>
                <button type="submit" form="form-rejeitar" class="btn btn-reject">
                    <i class="fas fa-times"></i> Rejeitar
                </button>
            </div>
        </div>
        {% endif %}

    </div> {# Fim do card #}

    <div style="text-align: center; margin-top: 20px;">
        {# Link de Voltar - ajusta o destino dependendo se pode aprovar ou não #}
        {% if pode_aprovar_rejeitar %}
            <a href="{% url 'listar_mps_para_aprovar' %}" class="btn btn-cancel">Voltar para Lista</a>
        {% elif request.user.funcionario == mp.solicitante %}
             <a href="{% url 'minhas_mps' %}" class="btn btn-cancel">Voltar para Minhas MPs</a>
        {% else %}
             {# Fallback (ex: Diretor ou RH vendo o histórico) #}
             <a href="{% url 'dashboard' %}" class="btn btn-cancel">Voltar</a> {# Ou um histórico geral? #}
        {% endif %}
    </div>

</div>
{% endblock content %}