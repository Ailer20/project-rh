{% extends 'base.html' %}
{% load static %}

{% block title %}{{ titulo_pagina|default:"Detalhes do Desligamento" }}{% endblock title %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/rh/rd_detail.css' %}">
{% endblock extra_css %}

{% block content %}
<div class="rd-detail-container">

    <div class="page-header">
        <h1>{{ titulo_pagina|default:"Detalhes do Desligamento" }}</h1>
        <span class="status-badge status-{{ rd.status }}">{{ rd.get_status_display }}</span>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <div class="card detail-card">
        
        <div class="detail-section">
            <h3>Informações do Funcionário</h3>
            <div class="detail-item"><strong>Funcionário:</strong> <span>{{ rd.funcionario_desligado.nome }}</span></div>
            <div class="detail-item"><strong>Cargo Atual:</strong> <span>{{ rd.cargo_atual.nome|default:"N/A" }}</span></div>
            <div class="detail-item"><strong>Setor Atual:</strong> <span>{{ rd.setor_atual.nome|default:"N/A" }}</span></div>
            <div class="detail-item"><strong>Data Admissão:</strong> <span>{{ rd.data_admissao|date:"d/m/Y"|default:"N/A" }}</span></div>
            <div class="detail-item"><strong>Solicitante:</strong> <span>{{ rd.solicitante.nome }}</span></div>
        </div>
        
        <div class="detail-section">
            <h3>Detalhes do Desligamento</h3>
            <div class="detail-item"><strong>Tipo de Desligamento:</strong> <span>{{ rd.get_tipo_desligamento_display }}</span></div>
            <div class="detail-item"><strong>Motivo:</strong> <span>{{ rd.get_motivo_display }}</span></div>
            <div class="detail-item"><strong>Data Prevista:</strong> <span>{{ rd.data_prevista_desligamento|date:"d/m/Y" }}</span></div>
            <div class="detail-item"><strong>Aviso Prévio:</strong> <span>{{ rd.get_tipo_aviso_display }}</span></div>
            <div class="detail-item"><strong>Haverá Substituição:</strong> <span>{% if rd.havera_substituicao %}Sim{% else %}Não{% endif %}</span></div>
            <div class="detail-item"><strong>Justificativa:</strong> <span class="pre-line">{{ rd.justificativa|default:"Nenhuma" }}</span></div>
        </div>

        <div class="detail-section">
            <h3>Histórico de Aprovação</h3>
            <div class="detail-item"><strong>Status Atual:</strong> <span>{{ rd.get_status_display }}</span></div>

            {% if rd.status == 'rejeitada' %}
                <div class="detail-item"><strong>Rejeitado Por:</strong> <span>{{ rd.rejeitado_por.nome|default:"-" }} em {{ rd.data_rejeicao|date:"d/m/Y H:i"|default:"-" }}</span></div>
                <div class="detail-item"><strong>Observação:</strong> <span class="pre-line" style="color: #dc3545;">{{ rd.observacao_rejeicao|default:"-" }}</span></div>
            
            {% elif rd.status == 'aprovada' %}
                <div class="detail-item"><strong>Aprovado por Gestor:</strong> <span>{{ rd.aprovado_por_gestor.nome|default:"-" }} em {{ rd.data_aprovacao_gestor|date:"d/m/Y H:i" }}</span></div>
                <div class="detail-item"><strong>Aprovado por RH:</strong> <span>{{ rd.aprovado_por_rh.nome|default:"-" }} em {{ rd.data_aprovacao_rh|date:"d/m/Y H:i" }}</span></div>
            
            {% elif rd.aprovador_atual %}
                <div class="detail-item"><strong>Aguardando Aprovação de:</strong> <span>{{ rd.aprovador_atual.nome }}</span></div>
                {% if rd.aprovado_por_gestor %}
                    <div class="detail-item"><strong>Aprovado por Gestor:</strong> <span>{{ rd.aprovado_por_gestor.nome }} em {{ rd.data_aprovacao_gestor|date:"d/m/Y H:i" }}</span></div>
                {% endif %}
            {% endif %}
        </div>

        {# Seção de Ações (Apenas para o Aprovador Atual) #}
        {% if pode_aprovar_rejeitar %}
        <div class="approval-section">
            <h3>Sua Ação</h3>
            <p>Por favor, analise a solicitação de desligamento e tome uma ação.</p>

            {# Formulário de Rejeição #}
            <form method="post" action="{% url 'rejeitar_rd' rd.pk %}" id="form-rejeitar"> {# REMOVIDO 'post/' do final #}
                {% csrf_token %}
                <div class="form-group">
                    <label for="observacao_rejeicao">Observação (Obrigatória para Rejeitar):</label>
                    <textarea name="observacao" id="observacao_rejeicao" rows="3" placeholder="Informe o motivo da rejeição..."></textarea>
                </div>
            </form>

            {# Formulário de Aprovação (simples) #}
            <form method="post" action="{% url 'aprovar_rd' rd.pk %}" id="form-aprovar"> {# REMOVIDO 'post/' do final #}
                {% csrf_token %}
            </form>

            {# Botões que acionam os formulários #}
            <div class="approval-actions">
                <button type="submit" form="form-aprovar" class="btn btn-approve">
                    <i class="fas fa-check"></i> Aprovar e Encaminhar
                </button>
                <button type="submit" form="form-rejeitar" class="btn btn-reject">
                    <i class="fas fa-times"></i> Rejeitar
                </button>
            </div>
        </div>
        {% endif %}

    </div> {# Fim do card #}

    <div style="text-align: center; margin-top: 20px;">
        {# Link de Voltar #}
        {% if pode_aprovar_rejeitar %}
            <a href="{% url 'listar_rds_para_aprovar' %}" class="btn btn-cancel">Voltar para Lista</a>
        {% elif request.user.funcionario == rd.solicitante %}
             <a href="{% url 'minhas_rds' %}" class="btn btn-cancel">Voltar para Minhas RDs</a>
        {% else %}
             <a href="{% url 'dashboard' %}" class="btn btn-cancel">Voltar</a>
        {% endif %}
    </div>

</div>
{% endblock content %}